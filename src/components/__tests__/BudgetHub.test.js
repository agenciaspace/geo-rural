import React from 'react';
import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import '@testing-library/jest-dom';
import BudgetHub from '../BudgetHub';
import { useAuth } from '../../hooks/useAuth';
import { db } from '../../config/supabase';

// Mock das depend√™ncias
jest.mock('../../hooks/useAuth');
jest.mock('../../config/supabase');
jest.mock('react-router-dom', () => ({
  ...jest.requireActual('react-router-dom'),
  useNavigate: () => jest.fn(),
}));

// Helper para renderizar componente com Router
const renderWithRouter = (component) => {
  return render(
    <BrowserRouter future={{ v7_startTransition: true, v7_relativeSplatPath: true }}>
      {component}
    </BrowserRouter>
  );
};

// Mock dos dados de teste
const mockBudgets = [
  {
    id: '1',
    budget_request: {
      client_name: 'Jo√£o Silva',
      client_email: 'joao@email.com',
      property_name: 'Fazenda S√£o Jos√©',
      city: 'S√£o Paulo',
      state: 'SP',
      vertices_count: 4,
      property_area: 10.5,
      client_type: 'pessoa_fisica'
    },
    budget_result: {
      total_price: 5000,
      breakdown: [
        { item: 'Levantamento', value: 3000 },
        { item: 'Relat√≥rio', value: 2000 }
      ]
    },
    status: 'active',
    custom_link: 'orcamento-123',
    created_at: '2024-01-01T10:00:00Z'
  },
  {
    id: '2',
    budget_request: {
      client_name: 'Maria Santos',
      client_email: 'maria@email.com',
      property_name: 'S√≠tio Esperan√ßa',
      city: 'Rio de Janeiro',
      state: 'RJ',
      vertices_count: 6,
      property_area: 25.0,
      client_type: 'pessoa_juridica'
    },
    budget_result: {
      total_price: 8000,
      breakdown: [
        { item: 'Levantamento', value: 5000 },
        { item: 'Relat√≥rio', value: 3000 }
      ]
    },
    status: 'approved',
    custom_link: 'orcamento-456',
    created_at: '2024-01-02T10:00:00Z'
  }
];

const mockClients = [
  {
    id: '1',
    name: 'Jo√£o Silva',
    email: 'joao@email.com',
    phone: '(11) 99999-9999',
    client_type: 'pessoa_fisica'
  },
  {
    id: '2',
    name: 'Maria Santos',
    email: 'maria@email.com',
    phone: '(21) 88888-8888',
    client_type: 'pessoa_juridica'
  }
];

describe('BudgetHub', () => {
  beforeEach(() => {
    // Mock do useAuth
    useAuth.mockReturnValue({
      isAuthenticated: true,
      user: { id: 'user1', email: 'user@test.com' }
    });

    // Mock das fun√ß√µes do banco
    db.budgets = {
      list: jest.fn(),
      create: jest.fn(),
      update: jest.fn(),
      delete: jest.fn()
    };

    db.clients = {
      list: jest.fn(),
      create: jest.fn()
    };

    // Reseta os mocks
    jest.clearAllMocks();
  });

  describe('Renderiza√ß√£o inicial', () => {
    test('deve renderizar o t√≠tulo e subt√≠tulo corretamente', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ data: [], error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      expect(screen.getByText('üè¢ Central de Or√ßamentos')).toBeInTheDocument();
      expect(screen.getByText('Crie, edite e gerencie todos os seus or√ßamentos em um s√≥ lugar')).toBeInTheDocument();
    });

    test('deve renderizar os bot√µes de navega√ß√£o', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ data: [], error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      expect(screen.getByText('üìã Listar Or√ßamentos')).toBeInTheDocument();
      expect(screen.getByText('‚ûï Criar Or√ßamento')).toBeInTheDocument();
    });

    test('deve chamar as fun√ß√µes de carregamento na inicializa√ß√£o', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        expect(db.budgets.list).toHaveBeenCalled();
        expect(db.clients.list).toHaveBeenCalled();
      }, { timeout: 3000 });
    });
  });

  describe('Lista de or√ßamentos', () => {
    test('deve exibir or√ßamentos carregados', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        expect(screen.getByText('Jo√£o Silva')).toBeInTheDocument();
        expect(screen.getByText('Maria Santos')).toBeInTheDocument();
        expect(screen.getByText('Fazenda S√£o Jos√©')).toBeInTheDocument();
        expect(screen.getByText('S√≠tio Esperan√ßa')).toBeInTheDocument();
      }, { timeout: 3000 });
    });

    test('deve exibir mensagem quando n√£o h√° or√ßamentos', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ data: [], error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        expect(screen.getByText('üìù Nenhum or√ßamento criado ainda')).toBeInTheDocument();
      }, { timeout: 3000 });
    });

    test('deve filtrar or√ßamentos por termo de busca', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        expect(screen.getByText('Jo√£o Silva')).toBeInTheDocument();
        expect(screen.getByText('Maria Santos')).toBeInTheDocument();
      }, { timeout: 3000 });

      const searchInput = screen.getByPlaceholderText('üîç Buscar por cliente ou propriedade...');
      
      await act(async () => {
        fireEvent.change(searchInput, { target: { value: 'Jo√£o' } });
      });

      expect(screen.getByText('Jo√£o Silva')).toBeInTheDocument();
      expect(screen.queryByText('Maria Santos')).not.toBeInTheDocument();
    });
  });

  describe('A√ß√µes dos or√ßamentos', () => {
    test('deve ter bot√£o "Ver Detalhes" para cada or√ßamento', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        const detailsButtons = screen.getAllByText('üìÑ Ver Detalhes');
        expect(detailsButtons).toHaveLength(2);
      }, { timeout: 3000 });
    });

    test('deve ter bot√£o "Editar" para cada or√ßamento', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        const editButtons = screen.getAllByText('‚úèÔ∏è Editar');
        expect(editButtons).toHaveLength(2);
      }, { timeout: 3000 });
    });

    test('deve ter bot√£o "Excluir" para cada or√ßamento', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      await act(async () => {
        renderWithRouter(<BudgetHub />);
      });

      await waitFor(() => {
        const deleteButtons = screen.getAllByText('üóëÔ∏è Excluir');
        expect(deleteButtons).toHaveLength(2);
      }, { timeout: 3000 });
    });
  });

  describe('Navega√ß√£o entre views', () => {
    test('deve mudar para view de cria√ß√£o ao clicar em "Criar Or√ßamento"', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      renderWithRouter(<BudgetHub />);

      const createButton = screen.getByText('‚ûï Criar Or√ßamento');
      fireEvent.click(createButton);

      await waitFor(() => {
        expect(screen.getByText('‚ûï Criar Novo Or√ßamento')).toBeInTheDocument();
      });
    });

    test('deve voltar para lista ao clicar em "Listar Or√ßamentos"', async () => {
      db.budgets.list.mockResolvedValue({ data: mockBudgets, error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      renderWithRouter(<BudgetHub />);

      // Vai para cria√ß√£o
      const createButton = screen.getByText('‚ûï Criar Or√ßamento');
      fireEvent.click(createButton);

      await waitFor(() => {
        expect(screen.getByText('‚ûï Criar Novo Or√ßamento')).toBeInTheDocument();
      });

      // Volta para lista
      const listButton = screen.getByText('üìã Listar Or√ßamentos');
      fireEvent.click(listButton);

      await waitFor(() => {
        expect(screen.getByText('Jo√£o Silva')).toBeInTheDocument();
      });
    });
  });

  describe('Tratamento de erros', () => {
    test('deve exibir mensagem de erro quando falha ao carregar or√ßamentos', async () => {
      db.budgets.list.mockResolvedValue({ 
        data: null, 
        error: { message: 'Erro de conex√£o' } 
      });
      db.clients.list.mockResolvedValue({ data: [], error: null });

      renderWithRouter(<BudgetHub />);

      await waitFor(() => {
        expect(screen.getByText(/‚ùå.*Erro de conex√£o/)).toBeInTheDocument();
      });
    });

    test('deve exibir mensagem de erro quando falha ao carregar clientes', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ 
        data: null, 
        error: { message: 'Erro ao carregar clientes' } 
      });

      renderWithRouter(<BudgetHub />);

      await waitFor(() => {
        expect(screen.getByText(/‚ùå.*Erro ao carregar clientes/)).toBeInTheDocument();
      });
    });
  });

  describe('Estados de loading', () => {
    test('deve mostrar estado de loading durante carregamento', async () => {
      // Mock para delay no carregamento
      db.budgets.list.mockImplementation(() => 
        new Promise(resolve => 
          setTimeout(() => resolve({ data: [], error: null }), 100)
        )
      );
      db.clients.list.mockResolvedValue({ data: [], error: null });

      renderWithRouter(<BudgetHub />);

      expect(screen.getByText('‚è≥ Carregando or√ßamentos...')).toBeInTheDocument();

      await waitFor(() => {
        expect(screen.queryByText('‚è≥ Carregando or√ßamentos...')).not.toBeInTheDocument();
      });
    });
  });

  describe('Valida√ß√£o de formul√°rio', () => {
    test('deve desabilitar bot√£o de criar quando formul√°rio est√° inv√°lido', async () => {
      db.budgets.list.mockResolvedValue({ data: [], error: null });
      db.clients.list.mockResolvedValue({ data: mockClients, error: null });

      renderWithRouter(<BudgetHub />);

      const createButton = screen.getByText('‚ûï Criar Or√ßamento');
      fireEvent.click(createButton);

      await waitFor(() => {
        const submitButton = screen.getByText('üíæ Criar Or√ßamento');
        expect(submitButton).toBeDisabled();
      });
    });
  });
});